<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${match.matchTitle} + ' - Stadium Registration'">Match Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stadium-diagram {
            border: 2px solid #333;
            border-radius: 10px;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            position: relative;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .football-field {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 120px;
            background: #4CAF50;
            border: 2px solid #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .stadium-section {
            position: absolute;
            border: 2px solid #333;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .stadium-section:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .section-available {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            border-color: #2E7D32;
        }

        .section-limited {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            border-color: #E65100;
        }

        .section-full {
            background: linear-gradient(135deg, #F44336, #EF5350);
            border-color: #C62828;
            cursor: not-allowed;
        }

        .section-vip {
            background: linear-gradient(135deg, #9C27B0, #BA68C8);
            border-color: #6A1B9A;
        }

        .section-premium {
            background: linear-gradient(135deg, #3F51B5, #7986CB);
            border-color: #283593;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid #333;
        }

        .booking-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .booking-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/matches">
                <i class="fas fa-futbol"></i> Stadium Registration
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/matches">Matches</a>
                    </li>
                    <li class="nav-item" sec:authorize="isAuthenticated()">
                        <a class="nav-link" href="/bookings">My Bookings</a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" href="/admin">Admin</a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item" sec:authorize="!isAuthenticated()">
                        <a class="nav-link" href="/login">Login</a>
                    </li>
                    <li class="nav-item" sec:authorize="!isAuthenticated()">
                        <a class="nav-link" href="/register">Register</a>
                    </li>
                    <li class="nav-item dropdown" sec:authorize="isAuthenticated()">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> <span sec:authentication="name"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/bookings">My Bookings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="d-inline">
                                    <button type="submit" class="dropdown-item">Logout</button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/matches">Matches</a></li>
                <li class="breadcrumb-item active" th:text="${match.matchTitle}">Match Details</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Match Information -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0" th:text="${match.matchTitle}">Team A vs Team B</h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-map-marker-alt text-primary"></i> Stadium Information</h5>
                                <ul class="list-unstyled">
                                    <li><strong>Name:</strong> <span th:text="${match.stadium.name}">Stadium Name</span></li>
                                    <li><strong>City:</strong> <span th:text="${match.stadium.city}">City</span></li>
                                    <li><strong>Address:</strong> <span th:text="${match.stadium.address}">Address</span></li>
                                    <li><strong>Capacity:</strong> <span th:text="${match.stadium.totalCapacity}">50000</span> seats</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-calendar text-info"></i> Match Details</h5>
                                <ul class="list-unstyled">
                                    <li><strong>Date:</strong> <span th:text="${#temporals.format(match.matchDate, 'dd MMMM yyyy')}">Date</span></li>
                                    <li><strong>Time:</strong> <span th:text="${#temporals.format(match.matchDate, 'HH:mm')}">Time</span></li>
                                    <li><strong>Status:</strong>
                                        <span class="badge bg-success" th:text="${match.status}">SCHEDULED</span>
                                    </li>
                                    <li><strong>Base Ticket Price:</strong>
                                        <span class="text-success fw-bold" th:text="'$' + ${match.ticketPrice}">$25.00</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div th:if="${match.description}" class="mt-3">
                            <h5><i class="fas fa-info-circle"></i> Description</h5>
                            <p th:text="${match.description}">Match description</p>
                        </div>
                    </div>
                </div>

                <!-- Stadium Diagram -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-eye"></i> Stadium Seat Map - Choose Your Section</h5>
                    </div>
                    <div class="card-body">
                        <!-- Legend -->
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color section-available"></div>
                                <span>Available (Many seats)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color section-limited"></div>
                                <span>Limited (Few seats)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color section-full"></div>
                                <span>Sold Out</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color section-vip"></div>
                                <span>VIP Section</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color section-premium"></div>
                                <span>Premium Section</span>
                            </div>
                        </div>

                        <!-- Stadium Diagram Container -->
                        <div class="stadium-diagram"
                             th:attr="data-width=${match.stadium.diagramWidth}, data-height=${match.stadium.diagramHeight}"
                             th:style="'width: ' + ${match.stadium.diagramWidth} + 'px; height: ' + ${match.stadium.diagramHeight} + 'px; margin: 0 auto;'">

                            <!-- Football Field -->
                            <div class="football-field">
                                <i class="fas fa-futbol"></i> FIELD
                            </div>

                            <!-- Stadium Sections -->
                            <div th:each="section : ${sections}"
                                 class="stadium-section"
                                 th:attr="data-section-id=${section.id},
                                         data-section-name=${section.sectionName},
                                         data-section-type=${section.sectionType},
                                         data-total-seats=${section.totalSeats},
                                         data-price-multiplier=${section.priceMultiplier}"
                                 th:style="'left: ' + ${section.positionX} + 'px; top: ' + ${section.positionY} + 'px; width: ' + ${section.width} + 'px; height: ' + ${section.height} + 'px;'"
                                 th:onclick="'openBookingModal(' + ${section.id} + ')'">
                                <div th:text="${section.sectionName}">Section A</div>
                                <div class="section-seats" th:text="'Loading...'">Loading...</div>
                            </div>
                        </div>

                        <div class="text-center mt-3">
                            <p class="text-muted">
                                <i class="fas fa-mouse-pointer"></i> Click on any available section to book your seats
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Summary -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users"></i> Overall Seat Availability</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <span class="display-4"
                                  th:classappend="${match.availableSeats > 100} ? 'text-success' : (${match.availableSeats > 20} ? 'text-warning' : 'text-danger')"
                                  th:text="${match.availableSeats}">150</span>
                            <div class="text-muted">Total Available Seats</div>
                        </div>

                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar"
                                 th:classappend="${match.availableSeats > 100} ? 'bg-success' : (${match.availableSeats > 20} ? 'bg-warning' : 'bg-danger')"
                                 th:style="'width: ' + ${(match.availableSeats * 100.0 / match.stadium.totalCapacity)} + '%'">
                            </div>
                        </div>

                        <small class="text-muted">
                            <span th:text="${match.stadium.totalCapacity - match.availableSeats}">100</span> of
                            <span th:text="${match.stadium.totalCapacity}">250</span> seats booked
                        </small>
                    </div>
                </div>

                <!-- Traditional Booking Form (fallback) -->
                <div class="card mt-3" th:if="${match.availableSeats > 0}">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-ticket-alt"></i> Quick Book (Any Section)</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${!isLoggedIn}" class="text-center">
                            <p class="text-muted mb-3">You need to login to book tickets</p>
                            <a href="/login" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i> Login to Book
                            </a>
                        </div>

                        <form th:if="${isLoggedIn}" th:action="@{/matches/book/{id}(id=${match.id})}" method="post">
                            <div class="mb-3">
                                <label for="numberOfSeats" class="form-label">Number of Seats</label>
                                <select class="form-select" id="numberOfSeats" name="numberOfSeats" required>
                                    <option value="">Select seats</option>
                                    <option th:each="i : ${#numbers.sequence(1, T(java.lang.Math).min(10, match.availableSeats))}"
                                            th:value="${i}"
                                            th:text="${i} + ' seat' + (${i > 1} ? 's' : '') + ' - $' + ${match.ticketPrice * i}">
                                        1 seat - $25.00
                                    </option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-shopping-cart"></i> Book Any Available Section
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Booking Modal -->
    <div id="bookingModal" class="booking-modal">
        <div class="booking-modal-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 id="modalTitle">Book Section</h4>
                <button type="button" class="btn-close" onclick="closeBookingModal()"></button>
            </div>

            <div id="modalContent">
                <div class="mb-3">
                    <strong>Section:</strong> <span id="sectionName"></span>
                    <span id="sectionType" class="badge ms-2"></span>
                </div>
                <div class="mb-3">
                    <strong>Available Seats:</strong> <span id="availableSeats"></span>
                </div>
                <div class="mb-3">
                    <strong>Price per Seat:</strong> $<span id="sectionPrice"></span>
                </div>

                <div th:if="${!isLoggedIn}" class="text-center">
                    <p class="text-muted mb-3">You need to login to book tickets</p>
                    <a href="/login" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Login to Book
                    </a>
                </div>

                <form th:if="${isLoggedIn}" id="sectionBookingForm" method="post">
                    <!-- CSRF Token -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <div class="mb-3">
                        <label for="modalNumberOfSeats" class="form-label">Number of Seats</label>
                        <select class="form-select" id="modalNumberOfSeats" name="numberOfSeats" required>
                            <option value="">Select seats</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <strong>Total Price:</strong> $<span id="totalPrice">0.00</span>
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-shopping-cart"></i> Book Selected Section
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const matchId = /*[[${match.id}]]*/ 0;
        const baseTicketPrice = /*[[${match.ticketPrice}]]*/ 0;
        let sectionsData = {};

        // Load section availability data
        async function loadSectionData() {
            try {
                const response = await fetch(`/matches/api/${matchId}/sections`);
                const sections = await response.json();

                sections.forEach(section => {
                    sectionsData[section.id] = section;
                    updateSectionDisplay(section);
                });
            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        function updateSectionDisplay(section) {
            const sectionElement = document.querySelector(`[data-section-id="${section.id}"]`);
            if (!sectionElement) return;

            const seatsDisplay = sectionElement.querySelector('.section-seats');
            seatsDisplay.textContent = `${section.availableSeats}/${section.totalSeats}`;

            // Remove existing status classes
            sectionElement.classList.remove('section-available', 'section-limited', 'section-full');

            // Add appropriate status class
            if (section.availableSeats === 0) {
                sectionElement.classList.add('section-full');
                sectionElement.style.cursor = 'not-allowed';
            } else if (section.availableSeats <= section.totalSeats * 0.2) {
                sectionElement.classList.add('section-limited');
            } else {
                sectionElement.classList.add('section-available');
            }

            // Add section type styling
            if (section.type === 'VIP') {
                sectionElement.classList.add('section-vip');
            } else if (section.type === 'PREMIUM') {
                sectionElement.classList.add('section-premium');
            }
        }

        function openBookingModal(sectionId) {
            const section = sectionsData[sectionId];
            if (!section || section.availableSeats === 0) {
                alert('This section is sold out');
                return;
            }

            document.getElementById('sectionName').textContent = section.name;
            document.getElementById('sectionType').textContent = section.type;
            document.getElementById('sectionType').className = `badge ms-2 bg-${getSectionTypeColor(section.type)}`;
            document.getElementById('availableSeats').textContent = section.availableSeats;

            const sectionPrice = (baseTicketPrice * section.priceMultiplier).toFixed(2);
            document.getElementById('sectionPrice').textContent = sectionPrice;

            // Update form action
            const form = document.getElementById('sectionBookingForm');
            if (form) {
                form.action = `/matches/book/${matchId}/section/${sectionId}`;
            }

            // Populate seat options
            const select = document.getElementById('modalNumberOfSeats');
            select.innerHTML = '<option value="">Select seats</option>';

            for (let i = 1; i <= Math.min(10, section.availableSeats); i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i} seat${i > 1 ? 's' : ''} - $${(sectionPrice * i).toFixed(2)}`;
                select.appendChild(option);
            }

            // Add change listener for total price calculation
            select.onchange = function() {
                const seats = parseInt(this.value) || 0;
                const total = (sectionPrice * seats).toFixed(2);
                document.getElementById('totalPrice').textContent = total;
            };

            document.getElementById('bookingModal').style.display = 'block';
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        function getSectionTypeColor(type) {
            switch(type) {
                case 'VIP': return 'purple';
                case 'PREMIUM': return 'primary';
                case 'STANDARD': return 'success';
                case 'ECONOMY': return 'info';
                default: return 'secondary';
            }
        }

        // Close modal when clicking outside
        document.getElementById('bookingModal').onclick = function(event) {
            if (event.target === this) {
                closeBookingModal();
            }
        };

        // Load section data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSectionData();

            // Refresh data every 30 seconds
            setInterval(loadSectionData, 30000);
        });
    </script>
</body>
</html>
